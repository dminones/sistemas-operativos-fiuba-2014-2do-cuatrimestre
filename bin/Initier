#!/bin/bash

. Logger
GRUPO_PATH="$HOME/grupo05"
GRUPO_CONF="$GRUPO/conf"
ARCHIVO_CONF="$GRUPO/Deployer.conf"

readonly K_FALSE=0
readonly K_TRUE=1

logMessage(){
	#local BINDIR=`pwd`
	#local JOB_PATH=$BINDIR/../
	local LOG_DIR="logdir/"
	local LOG_FILE="$LOG_DIR""Initier"
	local WHERE=$1
	local CODE=$2
	local DESCRIPTION=$3
	log "$LOG_FILE" "$WHERE" "$CODE" "$DESCRIPTION"
}

ambienteEstaSeteado(){
	local SETEADO=$K_TRUE

	GRUPO_PATH="variable"
	GRUPO_CONF="variable"
	ARCHIVO_CONF="variable"
	BINDIR="variable"
	MAEDIR="variable"
	NOVEDIR="variable"
	DATASIZE="variable"
	ACEPDIR="variable"
	REPODIR="variable"
	RECHDIR="variable"
	LOGDIR="variable"
	DUPDIR="variable"

	if [ -z $GRUPO_PATH ] || [ -z $GRUPO_CONF ] || [ -z $ARCHIVO_CONF ] || [ -z $BINDIR ] || [ -z $MAEDIR ] || [ -z $NOVEDIR ] || [ -z $DATASIZE ] || [ -z $ACEPDIR ] || [ -z $REPODIR ] || [ -z $RECHDIR ] || [ -z $LOGDIR ] || [ -z $DUPDIR ];
	then
		SETEADO=$K_FALSE
	fi

	echo "$SETEADO"
}



iniciarVariablesDeAmbiente(){  # falta todo
IFS=$'\n'
for record in $(<$ARCHIVO_CONF)
do var
	log INFO "TP SO7508 Segundo Cuatrimestre 2014. Tema E Copyright Grupo 05"
	log INFO "Directorio Configuracion: $GRUPO_CONF (mostrar path y listar archivos)"
	log INFO "Directorio Ejecutables: $BINDIR (mostrar path y listar archivos)"
	log INFO "Directorio Tablas:$MAEDIR"
	log INFO "Directorio Flujo de Novedades: $NOVEDIR"
	log INFO "Directorio Novedades Aceptadas: $ACEPDIR"
	log INFO "Directorio Pedidos y Informes de Salida: $REPODIR"
	log INFO "Directorio Archivos Rechazados: $RECHDIR"
	log INFO "Directorio de Log de Comandos: $LOGDIR"
	log INFO "SubDirectorio de Resguardo de Archivos Duplicados: $DUPDIR"
	log INFO "Estado del Sistema: Inicializado"
done
}


cheackearInstalacionCompleta(){
	local COMPLETA=$K_TRUE
	
	#variables hardcodeadas temporalmente
	local BINDIR=`pwd`
	local JOB_PATH=$BINDIR/../
	local MAEDIR="$JOB_PATH/maedir/"
	
	local ARCHIVO_BANCOS="$MAEDIR/bancos.dat"
	local ARCHIVO_BANCOS_OK=`chequearArchivo "$ARCHIVO_BANCOS"`
	
	local ARCHIVO_CAMARAS="$MAEDIR/camaras.dat"
	local ARCHIVO_CAMARAS_OK=`chequearArchivo "$ARCHIVO_CAMARAS"`

	local ARCHIVO_PJN="$MAEDIR/pjn.dat"
	local ARCHIVO_PJN_OK=`chequearArchivo "$ARCHIVO_PJN"`

	if [ $ARCHIVO_BANCOS_OK -eq $K_FALSE ] || [ $ARCHIVO_CAMARAS_OK -eq $K_FALSE ] || [ $ARCHIVO_PJN_OK -eq $K_FALSE ];
	then
		echo "$K_FALSE"
	else
		echo "$K_TRUE"
	fi
}

chequearArchivo(){
	local ARCHIVO_OK=$K_TRUE
	local EXISTE=$K_TRUE
	local PERMISO=$K_TRUE
	
	if [ ! -f $1 ];
	then
		EXISTE=$K_FALSE
		logMessage "Initier" "war" "Falta el archivo $1. Instale nuevamente"
	else
		PERMISO=`chequearPermisosArchivo "$1"`
		if [ $PERMISO -eq $K_FALSE ];
		then
			logMessage "Initier" "war" "el archivo $1 no tiene permiso de lectura"	
		fi
	fi
	
	if [ $EXISTE -eq $K_FALSE ] || [ $PERMISO -eq $K_FALSE ];
	then
		echo "$K_FALSE"
	else
		echo "$K_TRUE"
	fi
}

chequearPermisosArchivo(){
	local PERMISO_LECTURA=$K_TRUE
	if [ ! -r $1 ];
	then
		chmod +r "$1"
		logMessage "chequearPermisosArchivo" "info" "Agregado permiso de lectura al archivo: $1"
	fi
	
	if [ ! -r $1 ];
	then
		PERMISO_LECTURA=$K_FALSE
	fi
	
	echo "$PERMISO_LECTURA"
}

darPermisos(){
ACCESO="$BINDIR/*"
for file in $ACCESO
do
	if [ "$file" != "ACCESO" ]
	then 
		chmod +x "$file"
	fi
done
}

arrancarRecept(){
echo "Desea efectuar la activacion del Recept?" Si - No
read respuesta
if [ $respuesta = 'Si'];
then
	ejecutarRecept
else 
	log INFO "Recept no activado. Si quiere arrancarlo ejecute el comando ./Debut.sh"
	echo "Recept no activado. Si quiere arrancarlo ejecute el comando ./Debut.sh"
fi
}

ejecutarRecept(){
./Recept.sh &
echo "Recept corriendo. Si quiere detenerlo ejecute el comando ./Stop.sh"
log INFO "Recept corriendo bajo el no. : <Process Id de Recept>. Si quiere detenerlo ejecute el comando ./Stop.sh"

}


#ejecucion
logMessage "Initier" "info" "Inicio de Initier"
AMBIENTE_SETEADO=`ambienteEstaSeteado`
if [ $AMBIENTE_SETEADO -eq $K_TRUE ];
then
	echo "Ambiente ya inicializado, si quiere reiniciar termine su sesion e ingrese nuevamente"
	logMessage "Initier" "war" "Ambiente ya inicializado, si quiere reiniciar termine su sesion e ingrese nuevamente"
	
	INSTALACION_COMPLETA=`cheackearInstalacionCompleta`
	if [ $INSTALACION_COMPLETA -eq $K_TRUE ];
	then
		echo "la instalacion esta completa"
	else
		echo "faltan cosas"
		#implementar rehacer instalacion
	fi
	
else
	echo "no inicializado"
fi
logMessage "Initier" "info" "Fin de Initier"




#if[$AMBIENTE=false]
#	then
#	echo "Inicilizando ambiente"
#	inicializarVariablesDeAmbiente
#	log INFO "Inicio de Initier"
#	log INFO "Inicializando ambiente"
#	checkearInstalacion
#	if[$instalacion = "NO"]
#		then log ERR"Instalacion incompleta.Falta un archivo. Por favor, verifique e intenten nuevamente."
#		echo "Instalacion incompleta.Falta un archivo. Por favor, verifique e intenten nuevamente."	
#		else
#		darPermisos
#		arrancarRecept
#		fi
#log ERR "Ambiente ya inicializado, si quiere reiniciar, termine su sesion e ingrese nuevamente."
#echo "Ambiente ya inicializado, si quiere reiniciar, termine su sesion e ingrese nuevamente."
#fi
#log "Initier" "Informative" "Fin de Initier"
#cerrarArchivoDeLogYTerminarProceso # falta todo
