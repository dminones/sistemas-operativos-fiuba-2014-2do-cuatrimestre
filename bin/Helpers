#!/bin/bash
. Logger

pushd `dirname $0` > /dev/null
BINDIR=`pwd`

popd > /dev/null

RECEPT="Recept"
FSOLDES="FSoldes"
CDOSSIER="CDossier"

LOGDIR_PATH=$GRUPO$LOGDIR
NOVEDIR_PATH=$GRUPO$NOVEDIR
ACEPDIR_PATH=$GRUPO$ACEPDIR
RECHDIR_PATH=$GRUPO$RECHDIR
MAEDIR_PATH=$GRUPO$MAEDIR

INITLOG=$LOGDIR_PATH"/ReceptInit"

RECEPT_LOG_NAME="Recept"
RECEPT_LOG="$LOGDIR_PATH/$RECEPT_LOG_NAME"

ERROR="[ERR]"

getFileContent() {
	if [ -f $1 ]; then
	  	echo $(<"$1")
	else
		echo 0
	fi
}

getProcessPid(){
	if [ "$(pgrep -f -o $1)" = "" ];then
			echo 0
	else
			pgrep -f -o $1
	fi
}


logError(){
	log "$RECEPT_LOG" "$RECEPT" "[ERR]" "$1"
}

logInfo(){
	log "$RECEPT_LOG" "$RECEPT" "[INFO]" "$1"
}

logWarning(){
	log "$RECEPT_LOG" "$RECEPT" "[WARN]" "$1"
}

Log(){
	logInfo $1
}

ambienteEstaSeteado(){
	local SETEADO=$K_TRUE

	if [ -z $GRUPO ] || [ -z $CONFDIR ] || [ -z $BINDIR ] || [ -z $MAEDIR ] || [ -z $NOVEDIR ] || [ -z $DATASIZE ] || [ -z $ACEPDIR ] || [ -z $REPODIR ] || [ -z $RECHDIR ] || [ -z $LOGDIR ] || [ -z $DUPDIR ];
	then
		SETEADO=$K_FALSE
	fi

	echo "$SETEADO"
}

# $1 Proceso a iniciar
initProcess(){
	processPid=$(getProcessPid $1)

	if [ $processPid -eq 0 ]; then

			echo -n "Iniciando $1...   "

			if [ -f $INITLOG ]; then
					rm $INITLOG
			fi

			if [ $RECEPT == $1 ]; then
					initBackground $1
			else
					initForeground $1
			fi

			error=$(cat $INITLOG)
			if [ -s $INITLOG ]; then
					Log "No pudo iniciarse $1: "$error
			else
					echo "[OK]"
			fi

	else
		echo "$1 corriendo bajo el no.: "$processPid
		Log "Invocacion de $1 pospuesta para el siguiente ciclo"
	fi
}

initForeground(){
	$BINDIR_PATH/$1
}

initBackground(){
	$BINDIR_PATH/$1 >$INITLOG 2>&1 < /dev/null &
}



